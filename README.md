# SlipSnap

Десктоп приложение на PySide6 для быстрого создания скриншотов с встроенным редактором и мгновенной отправкой в буфер обмена.

## Основные возможности

- **Захват экрана** — произвольная область или весь виртуальный рабочий стол
- **Гибкое выделение** — прямоугольник или эллипс с плавным переключением
- **Буфер обмена** — автоматическое копирование в PNG/DIB с сохранением прозрачности
- **Редактор изображений** — полный набор инструментов для аннотации и обработки
- **История снимков** — до 10 последних скриншотов с функцией создания коллажей
- **Настройка** — кастомные горячие клавиши и автосохранение параметров
- **Серийная съёмка** — автоматическое сохранение последовательных кадров в выбранную папку
- **Видео-захват 5-10 сек** — запись выбранной области с экспортом в MP4 или GIF
- **Библиотека мемов** — быстрый доступ к заготовленным наклейкам и их вставка в редактор
- **Мониторинг ресурсов** — фоновый сбор статистики CPU/GPU/памяти и сохранение отчётов

## Установка и запуск

### Требования
- Python 3.8+
- PySide6
- FFmpeg (должен быть доступен в `PATH` для видео-захвата MP4/GIF)

### Установка
```bash
# Создание виртуального окружения
python -m venv .venv

# Активация окружения
# Windows:
.venv\Scripts\activate
# Linux/macOS:
source .venv/bin/activate

# Установка зависимостей
pip install -r requirements.txt
```

### Запуск
```bash
python main.py
```

При первом запуске откроется компактный лончер с кнопками управления.

## Использование

### Рабочий процесс

1. **Лончер** — плавающее окно поверх всех приложений с кнопками:
   - «Снимок» — запуск захвата экрана
   - «Видео» — запись короткого клипа 5-10 секунд
   - «Квадрат/Круг» — переключение формы выделения
   - Настройка горячей клавиши
   - «Закрыть» — выход из приложения

2. **Захват области** — экран затемняется, выделенная область остаётся яркой. Результат автоматически копируется в буфер и открывается в редакторе.

3. **Редактор** — окно «SlipSnap — Редактор» с полным набором инструментов:
   - Рисование (кисть, маркер, фигуры)
   - Текстовые блоки
   - Размытие областей
   - Управление слоями
   - Экспорт и история

4. **История** — автоматическое сохранение во временную папку. Команда «История» (`Ctrl+K`) позволяет выбрать несколько снимков и объединить их в коллаж.

### Видео-захват (5-10 сек)

1. Нажмите кнопку **«Видео»** в лончере.
2. Выделите область экрана.
3. Приложение записывает клип длительностью `video_duration_sec` (по умолчанию 6 сек, диапазон 5-10).
4. Нажмите `Esc`, чтобы отменить запись во время процесса.
5. После записи выберите формат сохранения: `MP4` или `GIF`.

Если FFmpeg недоступен, приложение покажет сообщение с предложением повторить проверку после установки.

### Серийная съёмка

- Включите режим через лончер (кнопка «Серия») или меню редактора.
- Укажите папку назначения и префикс имени файлов.
- Каждый скриншот, сделанный глобальной горячей клавишей, автоматически сохраняется, минуя редактор.
- Завершите серию клавишей `Esc` во время съёмки — появится краткий отчёт и кнопка для открытия папки.

### Библиотека мемов

- Откройте окно «Мемы» из панели инструментов редактора.
- Импортируйте изображения (PNG/JPEG/WebP и др.) — SlipSnap приведёт их к оптимальному размеру и формату.
- Дважды кликните по элементу для мгновенной вставки на холст или используйте `Ctrl+C` для копирования в буфер.
- Ненужные элементы можно выделить и удалить в пару кликов.

### Мониторинг ресурсов

- SlipSnap отслеживает загрузку CPU, RAM и, при наличии, GPU, отображая краткий статус в нижней панели.
- При завершении работы можно сохранить подробный текстовый отчёт с динамикой использования, статистикой событий и счётчиками действий.
- Мониторинг можно остановить из диалога закрытия приложения, чтобы не тратить ресурсы в простое.

## Горячие клавиши

### Глобальные
| Комбинация | Действие |
|------------|----------|
| `Ctrl+Alt+S` | Запуск захвата экрана (настраивается) |

### Режим выделения
| Клавиша | Действие |
|---------|----------|
| `ЛКМ` | Начать/завершить выделение |
| `Esc` | Отменить захват |
| `Space` | Переключить форму (прямоугольник/эллипс) |

### Редактор
| Комбинация | Действие |
|------------|----------|
| `Ctrl+N` | Новый скриншот |
| `Ctrl+Shift+N` | История с добавлением коллажа |
| `Ctrl+K` | Открыть историю |
| `Ctrl+A` | Выделить все объекты на холсте |
| `Ctrl+C` | Копировать в буфер |
| `Ctrl+S` | Сохранить в файл |
| `Ctrl+Z` / `Ctrl+X` | Отмена / Повтор |
| `Delete` | Удалить выделенный элемент |
| `Ctrl` + колесо | Масштабирование |
| `Ctrl` + `+` / `-` | Масштабирование клавиатурой |

> Советы: выделенные объекты можно перетянуть за пределы окна редактора, чтобы сразу создать файл со скриншотом выделения в папке назначения.

## Инструменты редактора

- **Выбор** — выделение, групповое перемещение объектов и перенос выделения в папку через перетаскивание
- **Кисть** — свободное рисование
- **Маркер** — полупрозрачное выделение
- **Фигуры** — прямоугольники, эллипсы, линии
- **Стрелки** — направленные указатели
- **Текст** — текстовые блоки с настройкой шрифта
- **Размытие (Блюр)** — маскировка конфиденциальной информации
- **Ластик** — удаление элементов

## Архитектура проекта

### Структура файлов
```
slipsnap/
├── main.py              # Точка входа
├── gui.py               # Интерфейс (лончер, оверлеи)
├── logic.py             # Конфигурация, история, захват
├── video_capture.py     # Контроллер видео-захвата области
├── video_encoding.py    # Кодирование MP4/GIF через ffmpeg
├── clipboard_utils.py   # Работа с буфером обмена
└── editor/              # Модуль редактора
    ├── editor_window.py # Главное окно редактора
    ├── ui/
    │   └── canvas.py    # Канвас и инструменты
    ├── tools/           # Реализация инструментов
    └── collage.py       # Диалог истории
```

### Основные компоненты

**main.py**
- Инициализация `QApplication`
- Запуск главного контроллера `App`

**logic.py**
- Управление конфигурацией (`~/.slipsnap_config.json`)
- История снимков (временная папка `slipsnap_history`)
- Захват экрана через пакет `mss`
- Конвертация между форматами PIL и Qt

**gui.py**
- `Launcher` — компактное окно управления
- `OverlayManager` — координация оверлеев для разных мониторов
- `ScreenOverlay` / `VirtualOverlay` — затемнение и выделение области
- `App` — главный контроллер с регистрацией горячих клавиш и запуском видео-захвата

**video_capture.py**
- Выбор области под запись
- Захват кадров 5-10 секунд с отменой по `Esc`
- Диалог сохранения и экспорт в `MP4`/`GIF`

**video_encoding.py**
- Проверка доступности `ffmpeg`
- Потоковая запись временного `MP4`
- Конвертация `MP4 -> GIF`

**clipboard_utils.py**
- Конвертация в PNG/DIB
- Кроссплатформенная работа с буфером обмена

**editor/**
- Полнофункциональный редактор изображений
- Система undo/redo
- Drag-and-drop для добавления изображений
- Создание коллажей из истории

## Конфигурация

### Настраиваемые параметры

- **Форма выделения** — `rect` или `ellipse` (кнопка в лончере или `Space`)
- **Горячая клавиша** — строка формата Qt (настраивается через лончер)
- **Толщина пера** — сохраняется между сеансами
- **Размер шрифта** — запоминается автоматически
- **Видео (новое)**:
  - `video_duration_sec` — длительность записи (жестко 5..10)
  - `video_fps` — FPS записи (10..24)
  - `video_default_format` — формат по умолчанию (`mp4`/`gif`)
  - `video_last_save_directory` — последняя папка сохранения видео

### Хранение данных

- **Конфигурация**: `~/.slipsnap_config.json`
- **История**: `${TEMP}/slipsnap_history/shot_*.png` (автоочистка при превышении лимита)


### Зависимости

Все необходимые пакеты перечислены в `requirements.txt`:
- PySide6 — фреймворк GUI
- mss — захват экрана
- Pillow — обработка изображений
- pyqtkeybind — глобальные горячие клавиши

## Build With Bundled FFmpeg

1. Put `ffmpeg.exe` into one of these locations in the repo root:
   - `ffmpeg.exe`
   - `ffmpeg/ffmpeg.exe`
   - `bin/ffmpeg.exe`
2. Build the executable:
   - `pyinstaller SlipSnap.spec`
3. Build the installer (Inno Setup):
   - `ISCC SlipSnap.iss`

Notes:
- `SlipSnap.spec` auto-detects `ffmpeg.exe` and bundles it into `SlipSnap.exe`.
- `SlipSnap.iss` packs `dist\*` from the current project folder (relative paths).
- Runtime FFmpeg discovery checks bundled locations first (`sys._MEIPASS` / рядом с `.exe`) and then `PATH`.

## GIF Workflow Notes (2026-02-28)

- Video save dialog now includes format choice (`MP4` / `GIF`) and GIF-only option "Add to meme library".
- No delayed post-save popup is shown after GIF export; the library decision is made at save time.
- Copying a GIF from meme library writes multiple clipboard formats:
  - `application/x-slipsnap-meme` with GIF path metadata,
  - `text/uri-list` with local file URL,
  - `image/gif` raw bytes (when available).
- Paste pipeline in editor is GIF-first:
  - It checks GIF MIME/custom MIME first and inserts animated GIF item.
  - It falls back to static image insertion only when GIF payload is not available.
- Meme library UI:
  - GIF thumbnails are animated.
  - GIF cards include a `GIF` badge.
  - Broken GIF files show a visible fallback preview.
- Current export behavior:
  - Saving editor canvas to image remains static; GIF items are rendered as their current frame in exported image.
- Manual QA сценарии: `gif_manual_test_checklist.md`.
